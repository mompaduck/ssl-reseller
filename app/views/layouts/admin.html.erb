<!DOCTYPE html>
<html>
  <head>
    <title>CertGate Admin</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>

  <body class="bg-gray-100 font-sans antialiased">
    <%= turbo_stream_from "admin_notifications" %>
    
    <div class="min-h-screen flex">
      <!-- Sidebar -->
      <aside class="w-64 bg-gray-900 text-white flex flex-col flex-shrink-0 h-screen sticky top-0">
        <div class="p-6 border-b border-gray-800 flex items-center gap-3 flex-shrink-0">
          <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
            <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
          </div>
          <span class="text-xl font-bold tracking-tight">CertGate Admin</span>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
          <%= link_to admin_root_path, class: "flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors #{request.path == admin_root_path ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            대시보드
          <% end %>

          <%= link_to admin_products_path, class: "flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors #{request.path.start_with?('/admin/products') ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <i data-lucide="package" class="w-5 h-5"></i>
            상품 관리
          <% end %>

          <%= link_to admin_orders_path, class: "flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors #{request.path.start_with?(admin_orders_path) ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
            주문 관리
          <% end %>

          <%= link_to admin_certificates_path, class: "flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors #{request.path.start_with?(admin_certificates_path) ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <i data-lucide="file-check" class="w-5 h-5"></i>
            인증서 관리
          <% end %>

          <%= link_to admin_users_path, class: "flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors #{request.path.start_with?('/admin/users') ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <i data-lucide="users" class="w-5 h-5"></i>
            사용자 관리
          <% end %>

          <%= link_to admin_tickets_path, class: "flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors #{request.path.start_with?('/admin/tickets') ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <i data-lucide="message-square" class="w-5 h-5"></i>
            고객 문의
          <% end %>
          
          
          <div class="pt-6 mt-6 border-t border-gray-800">
            <p class="px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">시스템</p>
            
            <%# Settings Dropdown Menu %>
            <% settings_active = request.path.include?('settings') %>
            <div class="settings-dropdown">
              <button onclick="toggleSettingsMenu()" class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors w-full text-left <%= settings_active ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white' %>">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span class="flex-1">설정</span>
                <i data-lucide="chevron-down" class="w-4 h-4 settings-chevron transition-transform"></i>
              </button>
              
              <div id="settingsSubmenu" class="ml-8 mt-1 space-y-1 <%= settings_active ? '' : 'hidden' %>">
                <%= link_to '#', class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors text-gray-400 hover:bg-gray-800 hover:text-white" do %>
                  <i data-lucide="shield" class="w-4 h-4"></i>
                  Security Settings
                <% end %>
                
                <%= link_to '#', class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors text-gray-400 hover:bg-gray-800 hover:text-white" do %>
                  <i data-lucide="bell" class="w-4 h-4"></i>
                  Notification Settings
                <% end %>
                
                <%= link_to admin_settings_email_smtp_path, class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors text-gray-400 hover:bg-gray-800 hover:text-white" do %>
                  <i data-lucide="mail" class="w-4 h-4"></i>
                  Email SMTP
                <% end %>
                
                <%= link_to '#', class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors text-gray-400 hover:bg-gray-800 hover:text-white" do %>
                  <i data-lucide="key" class="w-4 h-4"></i>
                  API Settings
                <% end %>
                
                <%= link_to '#', class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors text-gray-400 hover:bg-gray-800 hover:text-white" do %>
                  <i data-lucide="credit-card" class="w-4 h-4"></i>
                  Billing Settings
                <% end %>
                
                <%= link_to '#', class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors text-gray-400 hover:bg-gray-800 hover:text-white" do %>
                  <i data-lucide="database" class="w-4 h-4"></i>
                  Backup & Restore
                <% end %>
                
                <%= link_to admin_settings_logging_retention_path, class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors text-gray-400 hover:bg-gray-800 hover:text-white" do %>
                  <i data-lucide="clock" class="w-4 h-4"></i>
                  Logging Retention
                <% end %>
              </div>
            </div>

            <%# Logs Dropdown Menu %>
            <% logs_active = request.path.include?('_logs') %>
            <div class="logs-dropdown">
              <button onclick="toggleLogsMenu()" class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors w-full text-left <%= logs_active ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white' %>">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span class="flex-1">Logs</span>
                <i data-lucide="chevron-down" class="w-4 h-4 logs-chevron transition-transform"></i>
              </button>
              
              <div id="logsSubmenu" class="ml-8 mt-1 space-y-1 <%= logs_active ? '' : 'hidden' %>">
                <%= link_to admin_audit_logs_path, class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors #{request.path == admin_audit_logs_path ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
                  <i data-lucide="shield-check" class="w-4 h-4"></i>
                  Audit Logs
                <% end %>
                
                <%= link_to admin_order_logs_path, class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors #{request.path == admin_order_logs_path ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
                  <i data-lucide="shopping-bag" class="w-4 h-4"></i>
                  Order Logs
                <% end %>
                
                <%= link_to admin_certificate_logs_path, class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors #{request.path == admin_certificate_logs_path ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
                  <i data-lucide="award" class="w-4 h-4"></i>
                  Certificate Logs
                <% end %>
                
                <%= link_to admin_api_logs_path, class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors #{request.path == admin_api_logs_path ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
                  <i data-lucide="server" class="w-4 h-4"></i>
                  API Logs
                <% end %>
                
                <%= link_to admin_notification_logs_path, class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors #{request.path == admin_notification_logs_path ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
                  <i data-lucide="bell" class="w-4 h-4"></i>
                  Notification Logs
                <% end %>
                
                <%= link_to admin_system_logs_path, class: "flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors #{request.path == admin_system_logs_path ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
                  <i data-lucide="alert-circle" class="w-4 h-4"></i>
                  System Logs
                <% end %>
              </div>
            </div>
          </div>
        </nav>

        <div class="p-4 border-t border-gray-800 flex-shrink-0">
          <div class="flex items-center gap-3 px-4 py-3 bg-gray-800 rounded-lg mb-2">
            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
              <span class="text-xs font-bold text-white">AD</span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-white truncate">관리자</p>
              <p class="text-xs text-gray-500 truncate"><%= current_user.email %></p>
            </div>
          </div>
          <%= button_to destroy_user_session_path, method: :delete, class: "flex items-center gap-3 px-4 py-3 text-sm font-medium text-red-400 rounded-lg hover:bg-red-900/20 hover:text-red-300 transition-colors w-full text-left", form: { class: "w-full" } do %>
            <i data-lucide="log-out" class="w-5 h-5"></i>
            <span>로그아웃</span>
          <% end %>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <!-- Top bar (Mobile only mostly, or breadcrumbs) -->
        <header class="bg-white shadow-sm border-b border-gray-200 lg:hidden">
          <div class="px-4 py-4 flex items-center justify-between">
            <span class="text-lg font-bold text-gray-900">CertGate Admin</span>
            <button class="text-gray-500 hover:text-gray-700">
              <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
          </div>
        </header>

        <div class="flex-1 overflow-auto bg-gray-50 p-8">
          <!-- Flash Messages -->
          <% if notice.present? || alert.present? %>
            <div class="mb-6 space-y-4">
              <% if notice.present? %>
                <div class="flash-message bg-green-50 border-l-4 border-green-400 p-4 rounded-lg shadow-sm animate-fade-in">
                  <div class="flex items-start">
                    <div class="flex-shrink-0">
                      <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                    </div>
                    <div class="ml-3">
                      <p class="text-sm text-green-800"><%= notice %></p>
                    </div>
                    <div class="ml-auto pl-3">
                      <button onclick="this.closest('.flash-message').remove()" class="text-green-400 hover:text-green-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                      </button>
                    </div>
                  </div>
                </div>
              <% end %>

              <% if alert.present? %>
                <div class="flash-message bg-red-50 border-l-4 border-red-400 p-4 rounded-lg shadow-sm animate-fade-in">
                  <div class="flex items-start">
                    <div class="flex-shrink-0">
                      <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
                    </div>
                    <div class="ml-3">
                      <p class="text-sm text-red-800"><%= alert %></p>
                    </div>
                    <div class="ml-auto pl-3">
                      <button onclick="this.closest('.flash-message').remove()" class="text-red-400 hover:text-red-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                      </button>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>

          <%= yield %>
        </div>
      </main>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        autoDismissFlashMessages();
      });
      document.addEventListener('turbo:load', () => {
        lucide.createIcons();
        autoDismissFlashMessages();
      });
      
      // Flash 메시지 자동 닫기
      function autoDismissFlashMessages() {
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(message => {
          setTimeout(() => {
            message.style.transition = 'opacity 0.5s ease-out';
            message.style.opacity = '0';
            setTimeout(() => {
              message.remove();
            }, 500);
          }, 5000); // 5초 후 자동으로 닫힘
        });
      }
      
      function toggleLogsMenu() {
        const submenu = document.getElementById('logsSubmenu');
        const chevron = document.querySelector('.logs-chevron');
        submenu.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
      }
      
      function toggleSettingsMenu() {
        const submenu = document.getElementById('settingsSubmenu');
        const chevron = document.querySelector('.settings-chevron');
        submenu.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
      }
    </script>
  </body>
</html>
