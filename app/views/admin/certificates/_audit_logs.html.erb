<%= turbo_frame_tag "certificate_tab_content" do %>
<div id="content-audit-logs" class="tab-content">
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">

    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
        <i data-lucide="shield-check" class="w-5 h-5 text-indigo-600"></i>
        감사 로그 (Audit Logs)
      </h2>

      <%= link_to admin_audit_logs_path(auditable_type:"Certificate", auditable_id:@certificate.id),
        class:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1" do %>
        전체보기 <i data-lucide="external-link" class="w-3 h-3"></i>
      <% end %>
    </div>

    <p class="text-sm text-gray-600 mb-4">이 인증서에 대한 모든 관리자/시스템 작업 기록</p>

    <% if @certificate.audit_logs.any? %>

      <ul class="-mb-8">

        <% @certificate.audit_logs.order(created_at: :desc).limit(20).each_with_index do |log, idx| %>

          <li>
            <div class="relative pb-8">

              <% unless idx == @certificate.audit_logs.limit(20).count - 1 %>
                <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200"></span>
              <% end %>

              <div class="relative flex items-start space-x-3">

                <% icon_map = {
                  "create" => { bg:"bg-blue-500",  icon:"plus" },
                  "update" => { bg:"bg-purple-500",icon:"edit" },
                  "delete" => { bg:"bg-red-500",  icon:"trash-2" },
                  "reissue" =>{ bg:"bg-green-500",icon:"refresh-cw"},
                  "cancel" => { bg:"bg-red-500",  icon:"x-circle"},
                  "refresh_dcv" => { bg:"bg-blue-500", icon:"refresh-cw" },
                  "refresh_status" => { bg:"bg-purple-500", icon:"refresh-ccw" },
                  "change_dcv_method" => { bg:"bg-orange-500", icon:"repeat" }
                }[log.action] || { bg:"bg-gray-500", icon:"activity" } %>

                <span class="h-10 w-10 rounded-full <%= icon_map[:bg] %> flex items-center justify-center ring-8 ring-white">
                  <i data-lucide="<%= icon_map[:icon] %>" class="w-5 h-5 text-white"></i>
                </span>

                <div class="min-w-0 flex-1">

                  <div class="flex items-start justify-between">
                    <div>

                      <p class="text-sm font-medium text-gray-900"><%= log.action.titleize %></p>
                      <p class="text-sm text-gray-700"><%= log.message %></p>

                      <div class="flex items-center gap-3 text-xs text-gray-500 mt-1">
                        <span><i data-lucide="user" class="w-3 h-3"></i> <%= log.user&.name || "System" %></span>
                        <% if log.ip_address.present? %>
                          <span><i data-lucide="globe" class="w-3 h-3"></i> <%= log.ip_address %></span>
                        <% end %>
                      </div>

                      <% if log.metadata.present? %>
                        <details class="mt-2">
                          <summary class="text-xs text-gray-600 hover:text-gray-800 cursor-pointer">상세 정보</summary>
                          <div class="mt-2 p-3 bg-gray-50 border rounded">
                            <pre class="text-xs text-gray-700"><%= JSON.pretty_generate(log.metadata) %></pre>
                          </div>
                        </details>
                      <% end %>

                    </div>

                    <div class="text-right">
                      <p class="text-xs text-gray-500"><%= log.created_at.strftime("%Y-%m-%d") %></p>
                      <p class="text-xs text-gray-400"><%= log.created_at.strftime("%H:%M:%S") %></p>
                    </div>
                  </div>

                </div>

              </div>
            </div>
          </li>

        <% end %>

      </ul>

    <% else %>

      <div class="text-center py-8">
        <i data-lucide="inbox" class="w-12 h-12 text-gray-300 mx-auto mb-2"></i>
        <p class="text-sm text-gray-500">감사 로그가 없습니다.</p>
      </div>

    <% end %>

  </div>
</div>

<% end %>
