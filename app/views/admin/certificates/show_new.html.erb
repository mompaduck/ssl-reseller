<div class="mb-6">
  <div class="flex items-center gap-4 mb-2">
    <%= link_to admin_certificates_path, class: "p-2 rounded-lg hover:bg-gray-200 text-gray-500 transition" do %>
      <i data-lucide="arrow-left" class="w-5 h-5"></i>
    <% end %>
    <div class="flex-1">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold text-gray-900"><%= @certificate.order.domain %></h1>
        <% status_colors = {
          'pending' => 'bg-yellow-100 text-yellow-800',
          'issued' => 'bg-green-100 text-green-800',
          'expired' => 'bg-gray-100 text-gray-800',
          'revoked' => 'bg-red-100 text-red-800',
          'dcv_failed' => 'bg-red-100 text-red-800',
          'canceled' => 'bg-gray-100 text-gray-800'
        } %>
        <span class="px-3 py-1 rounded-full text-sm font-semibold <%= status_colors[@certificate.status] || 'bg-gray-100 text-gray-800' %>">
          <%= @certificate.status.upcase %>
        </span>
      </div>
      <p class="text-sm text-gray-500 mt-1">Certificate ID: #<%= @certificate.id %> | Order: <%= link_to @certificate.order.internal_order_id, admin_order_path(@certificate.order), class: "text-blue-600 hover:underline" %></p>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
  <!-- Main Content - 3 columns -->
  <div class="lg:col-span-3 space-y-6">
    
    <!-- Priority Section: Status + DCV (가장 중요) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      
      <!-- 발급/검증 상태 (왼쪽) -->
      <div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl shadow-sm border border-green-200 p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
          <i data-lucide="activity" class="w-5 h-5 text-green-600"></i>
          발급/검증 상태
        </h2>
        
        <div class="space-y-3">
          <!-- Certificate Status -->
          <div class="bg-white rounded-lg p-3 border border-green-200">
            <p class="text-xs text-gray-600 mb-1">Certificate Status</p>
            <% cert_status_config = {
              'pending' => { color: 'bg-yellow-100 text-yellow-800', icon: 'clock', label: 'Pending' },
              'issued' => { color: 'bg-green-100 text-green-800', icon: 'shield-check', label: 'Issued' },
              'expired' => { color: 'bg-gray-100 text-gray-800', icon: 'calendar-x', label: 'Expired' },
              'dcv_failed' => { color: 'bg-red-100 text-red-800', icon: 'alert-circle', label: 'DCV Failed' },
              'canceled' => { color: 'bg-gray-100 text-gray-800', icon: 'x-circle', label: 'Canceled' }
            } %>
            <% cert_info = cert_status_config[@certificate.status] || { color: 'bg-gray-100 text-gray-800', icon: 'help-circle', label: @certificate.status } %>
            <span class="px-3 py-1.5 rounded-full text-sm font-bold border <%= cert_info[:color] %>">
              <i data-lucide="<%= cert_info[:icon] %>" class="w-4 h-4 inline mr-1"></i>
              <%= cert_info[:label] %>
            </span>
          </div>
          
          <!-- Important Dates -->
          <div class="grid grid-cols-2 gap-2">
            <div class="bg-white rounded-lg p-2 border border-green-200">
              <p class="text-xs text-gray-500">발급일</p>
              <p class="text-sm font-semibold text-gray-900"><%= @certificate.issued_at&.strftime("%Y-%m-%d") || "-" %></p>
            </div>
            <div class="bg-white rounded-lg p-2 border border-green-200">
              <p class="text-xs text-gray-500">만료일</p>
              <% if @certificate.expires_at %>
                <% days_left = (@certificate.expires_at.to_date - Date.current).to_i %>
                <p class="text-sm font-semibold <%= days_left < 0 ? 'text-red-600' : days_left <= 30 ? 'text-orange-600' : 'text-green-600' %>">
                  <%= @certificate.expires_at.strftime("%Y-%m-%d") %>
                </p>
                <p class="text-xs <%= days_left < 0 ? 'text-red-500' : days_left <= 30 ? 'text-orange-500' : 'text-gray-400' %>">
                  <%= days_left < 0 ? "만료됨" : "D-#{days_left}" %>
                </p>
              <% else %>
                <p class="text-sm text-gray-400">-</p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
      
      <!-- DCV 상태 (오른쪽) -->
      <div class="bg-gradient-to-br from-orange-50 to-amber-100 rounded-xl shadow-sm border border-orange-200 p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
          <i data-lucide="key" class="w-5 h-5 text-orange-600"></i>
          DCV 상태
        </h2>
        
        <div class="space-y-3">
          <!-- DCV Method -->
          <div class="bg-white rounded-lg p-3 border border-orange-200">
            <p class="text-xs text-gray-600 mb-1">DCV 방식</p>
            <% if @certificate.dcv_method.present? %>
              <% method_config = {
                'EMAIL' => { color: 'bg-purple-100 text-purple-800', icon: 'mail' },
                'HTTP' => { color: 'bg-green-100 text-green-800', icon: 'globe' },
                'HTTPS' => { color: 'bg-blue-100 text-blue-800', icon: 'lock' },
                'DNS' => { color: 'bg-indigo-100 text-indigo-800', icon: 'server' },
                'CNAME' => { color: 'bg-indigo-100 text-indigo-800', icon: 'server' }
              } %>
              <% method_info = method_config[@certificate.dcv_method.upcase] || { color: 'bg-gray-100 text-gray-800', icon: 'help-circle' } %>
              <span class="px-3 py-1.5 rounded-lg text-sm font-bold border <%= method_info[:color] %>">
                <i data-lucide="<%= method_info[:icon] %>" class="w-4 h-4 inline mr-1"></i>
                <%= @certificate.dcv_method.upcase %>
              </span>
            <% else %>
              <span class="px-3 py-1.5 rounded-lg text-sm font-bold border bg-gray-100 text-gray-800">
                미설정
              </span>
            <% end %>
          </div>
          
          <!-- DCV Status -->
          <div class="bg-white rounded-lg p-3 border border-orange-200">
            <p class="text-xs text-gray-600 mb-1">검증 상태</p>
            <% 
              dcv_status = if @certificate.status == 'issued'
                'verified'
              elsif @certificate.status == 'dcv_failed'
                'failed'
              elsif @certificate.dcv_email.present? || @certificate.dcv_method.present?
                'in_progress'
              else
                'not_started'
              end
              
              dcv_status_config = {
                'not_started' => { color: 'bg-gray-100 text-gray-800', label: 'Not Started' },
                'in_progress' => { color: 'bg-blue-100 text-blue-800', label: 'In Progress' },
                'verified' => { color: 'bg-green-100 text-green-800', label: 'Verified' },
                'failed' => { color: 'bg-red-100 text-red-800', label: 'Failed' }
              }
              dcv_info = dcv_status_config[dcv_status]
            %>
            <span class="px-2 py-1 rounded-full text-xs font-semibold <%= dcv_info[:color] %>">
              <%= dcv_info[:label] %>
            </span>
          </div>
          
          <!-- Quick DCV Actions -->
          <div class="flex gap-2">
            <%= button_to resend_dcv_admin_certificate_path(@certificate), method: :post, class: "flex-1 px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition flex items-center justify-center gap-1" do %>
              <i data-lucide="send" class="w-3 h-3"></i>
              <span>재전송</span>
            <% end %>
            <%= button_to refresh_dcv_admin_certificate_path(@certificate), method: :post, class: "flex-1 px-3 py-2 bg-white border border-orange-300 text-orange-700 rounded-lg text-xs font-medium hover:bg-orange-50 transition flex items-center justify-center gap-1" do %>
              <i data-lucide="refresh-cw" class="w-3 h-3"></i>
              <span>새로고침</span>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- DCV 상세 정보 (문제 해결에 필수) -->
    <%= render partial: 'dcv_details', locals: { certificate: @certificate } %>
    
    <!-- 기본 정보 -->
    <%= render partial: 'certificate_overview', locals: { certificate: @certificate } %>
    
    <!-- 로그 섹션 -->
    <%= render partial: 'issue_logs', locals: { certificate: @certificate } %>
    
    <%= render partial: 'audit_logs', locals: { certificate: @certificate } %>

  </div>

  <!-- Right Sidebar - 1 column (관리 작업 + 정보) -->
  <div class="lg:col-span-1 space-y-6">
    
    <!-- 관리 작업 (최우선) -->
    <%= render partial: 'management_actions', locals: { certificate: @certificate } %>
    
    <!-- 고객 정보 -->
    <%= render partial: 'customer_info', locals: { certificate: @certificate } %>
    
    <!-- 주문 정보 -->
    <%= render partial: 'order_info', locals: { certificate: @certificate } %>

  </div>
</div>
