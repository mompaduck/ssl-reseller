<div class="mb-8">
  <h1 class="text-2xl font-bold text-gray-900">Audit Logs</h1>
  <p class="mt-1 text-sm text-gray-500">모든 시스템 및 관리자 작업 이력을 확인합니다.</p>
</div>

<!-- Filters -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
  <%= form_with url: admin_audit_logs_path, method: :get, class: "space-y-4" do |f| %>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Search -->
      <div>
        <%= f.label :q, "검색", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :q, 
            value: params[:q],
            placeholder: "메시지, 사용자 이름, 이메일...",
            class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" %>
      </div>

      <!-- Action Type Filter -->
      <div>
        <%= f.label :action_type, "액션 타입", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.select :action_type, 
            options_for_select([["전체", ""]] + @action_types.map { |t| [t.humanize, t] }, params[:action_type]),
            {},
            class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" %>
      </div>

      <!-- Date Range -->
      <div class="grid grid-cols-2 gap-2">
        <div>
          <%= f.label :start_date, "시작일", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.date_field :start_date,
              value: params[:start_date],
              class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" %>
        </div>
        <div>
          <%= f.label :end_date, "종료일", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.date_field :end_date,
              value: params[:end_date],
              class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" %>
        </div>
      </div>
    </div>

    <div class="flex gap-2">
      <%= f.submit "필터 적용", class: "px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium" %>
      <%= link_to "초기화", admin_audit_logs_path, class: "px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium" %>
    </div>
  <% end %>
</div>

<!-- Results Summary -->
<div class="mb-4 text-sm text-gray-600">
  총 <%= @audit_logs.total_count %>개의 로그 (페이지 <%= @audit_logs.current_page %> / <%= @audit_logs.total_pages %>)
</div>

<!-- Audit Logs Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">시간</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작업자</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">액션</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">메시지</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">대상</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP 주소</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% if @audit_logs.any? %>
          <% @audit_logs.each do |log| %>
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div class="flex flex-col">
                  <span class="font-medium text-gray-900"><%= log.created_at.strftime("%Y-%m-%d") %></span>
                  <span class="text-xs text-gray-500"><%= log.created_at.strftime("%H:%M:%S") %></span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center">
                    <i data-lucide="<%= log.user ? 'user' : 'cpu' %>" class="w-4 h-4 text-gray-500"></i>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900"><%= log.user&.name || "System" %></p>
                    <% if log.user %>
                      <p class="text-xs text-gray-500"><%= log.user.email %></p>
                    <% end %>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full <%= log.badge_color %>">
                  <%= log.formatted_action %>
                </span>
              </td>
              <td class="px-6 py-4 text-sm text-gray-900">
                <div class="max-w-md">
                  <%= log.message %>
                  <% if log.metadata.present? && log.metadata.is_a?(Hash) %>
                    <details class="mt-1">
                      <summary class="text-xs text-blue-600 cursor-pointer hover:text-blue-800">상세 정보</summary>
                      <pre class="mt-2 text-xs bg-gray-50 p-2 rounded border border-gray-200 overflow-x-auto"><%= JSON.pretty_generate(log.metadata) %></pre>
                    </details>
                  <% end %>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <% if log.auditable %>
                  <% case log.auditable_type %>
                  <% when 'User' %>
                    <%= link_to "User ##{log.auditable_id}", 
                        admin_user_path(log.auditable_id),
                        class: "text-blue-600 hover:text-blue-900" %>
                  <% when 'Certificate' %>
                    <%= link_to "Certificate ##{log.auditable_id}", 
                        admin_certificate_path(log.auditable_id),
                        class: "text-blue-600 hover:text-blue-900" %>
                  <% when 'Order' %>
                    <%= link_to "Order ##{log.auditable_id}", 
                        admin_order_path(log.auditable_id),
                        class: "text-blue-600 hover:text-blue-900" %>
                  <% when 'Payment' %>
                    <span class="text-gray-600">Payment #<%= log.auditable_id %></span>
                  <% else %>
                    <%= "#{log.auditable_type} ##{log.auditable_id}" %>
                  <% end %>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                <%= log.ip_address || "-" %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
              <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
              <p class="text-sm">로그가 없습니다.</p>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  <% if @audit_logs.total_pages > 1 %>
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
      <%= paginate @audit_logs, theme: 'twitter-bootstrap-4', 
          nav_class: 'flex justify-center',
          pagination_class: 'pagination flex gap-1' %>
    </div>
  <% end %>
</div>

<style>
  /* Kaminari pagination styling */
  .pagination {
    display: flex;
    gap: 0.25rem;
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .pagination .page-item {
    display: inline-block;
  }
  
  .pagination .page-link {
    display: block;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e5e7eb;
    background-color: white;
    color: #374151;
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s;
  }
  
  .pagination .page-link:hover {
    background-color: #f3f4f6;
    border-color: #d1d5db;
  }
  
  .pagination .page-item.active .page-link {
    background-color: #2563eb;
    border-color: #2563eb;
    color: white;
  }
  
  .pagination .page-item.disabled .page-link {
    color: #9ca3af;
    pointer-events: none;
    background-color: #f9fafb;
  }
</style>
